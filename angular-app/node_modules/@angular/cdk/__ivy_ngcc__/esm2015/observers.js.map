{"version":3,"file":"observers.js","sources":["../../../src/cdk/observers/observe-content.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {coerceBooleanProperty, coerceNumberProperty, coerceElement} from '@angular/cdk/coercion';\nimport {\n  AfterContentInit,\n  Directive,\n  ElementRef,\n  EventEmitter,\n  Injectable,\n  Input,\n  NgModule,\n  NgZone,\n  OnDestroy,\n  Output,\n} from '@angular/core';\nimport {Observable, Subject, Subscription, Observer} from 'rxjs';\nimport {debounceTime} from 'rxjs/operators';\n\n/**\n * Factory that creates a new MutationObserver and allows us to stub it out in unit tests.\n * @docs-private\n */\n@Injectable({providedIn: 'root'})\nexport class MutationObserverFactory {\n  create(callback: MutationCallback): MutationObserver | null {\n    return typeof MutationObserver === 'undefined' ? null : new MutationObserver(callback);\n  }\n}\n\n\n/** An injectable service that allows watching elements for changes to their content. */\n@Injectable({providedIn: 'root'})\nexport class ContentObserver implements OnDestroy {\n  /** Keeps track of the existing MutationObservers so they can be reused. */\n  private _observedElements = new Map<Element, {\n    observer: MutationObserver | null,\n    stream: Subject<MutationRecord[]>,\n    count: number\n  }>();\n\n  constructor(private _mutationObserverFactory: MutationObserverFactory) {}\n\n  ngOnDestroy() {\n    this._observedElements.forEach((_, element) => this._cleanupObserver(element));\n  }\n\n  /**\n   * Observe content changes on an element.\n   * @param element The element to observe for content changes.\n   */\n  observe(element: Element): Observable<MutationRecord[]>;\n\n  /**\n   * Observe content changes on an element.\n   * @param element The element to observe for content changes.\n   */\n  observe(element: ElementRef<Element>): Observable<MutationRecord[]>;\n\n  observe(elementOrRef: Element | ElementRef<Element>): Observable<MutationRecord[]> {\n    const element = coerceElement(elementOrRef);\n\n    return new Observable((observer: Observer<MutationRecord[]>) => {\n      const stream = this._observeElement(element);\n      const subscription = stream.subscribe(observer);\n\n      return () => {\n        subscription.unsubscribe();\n        this._unobserveElement(element);\n      };\n    });\n  }\n\n  /**\n   * Observes the given element by using the existing MutationObserver if available, or creating a\n   * new one if not.\n   */\n  private _observeElement(element: Element): Subject<MutationRecord[]> {\n    if (!this._observedElements.has(element)) {\n      const stream = new Subject<MutationRecord[]>();\n      const observer = this._mutationObserverFactory.create(mutations => stream.next(mutations));\n      if (observer) {\n        observer.observe(element, {\n          characterData: true,\n          childList: true,\n          subtree: true\n        });\n      }\n      this._observedElements.set(element, {observer, stream, count: 1});\n    } else {\n      this._observedElements.get(element)!.count++;\n    }\n    return this._observedElements.get(element)!.stream;\n  }\n\n  /**\n   * Un-observes the given element and cleans up the underlying MutationObserver if nobody else is\n   * observing this element.\n   */\n  private _unobserveElement(element: Element) {\n    if (this._observedElements.has(element)) {\n      this._observedElements.get(element)!.count--;\n      if (!this._observedElements.get(element)!.count) {\n        this._cleanupObserver(element);\n      }\n    }\n  }\n\n  /** Clean up the underlying MutationObserver for the specified element. */\n  private _cleanupObserver(element: Element) {\n    if (this._observedElements.has(element)) {\n      const {observer, stream} = this._observedElements.get(element)!;\n      if (observer) {\n        observer.disconnect();\n      }\n      stream.complete();\n      this._observedElements.delete(element);\n    }\n  }\n}\n\n\n/**\n * Directive that triggers a callback whenever the content of\n * its associated element has changed.\n */\n@Directive({\n  selector: '[cdkObserveContent]',\n  exportAs: 'cdkObserveContent',\n})\nexport class CdkObserveContent implements AfterContentInit, OnDestroy {\n  /** Event emitted for each change in the element's content. */\n  @Output('cdkObserveContent') event = new EventEmitter<MutationRecord[]>();\n\n  /**\n   * Whether observing content is disabled. This option can be used\n   * to disconnect the underlying MutationObserver until it is needed.\n   */\n  @Input('cdkObserveContentDisabled')\n  get disabled() { return this._disabled; }\n  set disabled(value: any) {\n    this._disabled = coerceBooleanProperty(value);\n    this._disabled ? this._unsubscribe() : this._subscribe();\n  }\n  private _disabled = false;\n\n  /** Debounce interval for emitting the changes. */\n  @Input()\n  get debounce(): number { return this._debounce; }\n  set debounce(value: number) {\n    this._debounce = coerceNumberProperty(value);\n    this._subscribe();\n  }\n  private _debounce: number;\n\n  private _currentSubscription: Subscription | null = null;\n\n  constructor(private _contentObserver: ContentObserver,\n              private _elementRef: ElementRef<HTMLElement>,\n              private _ngZone: NgZone) {}\n\n  ngAfterContentInit() {\n    if (!this._currentSubscription && !this.disabled) {\n      this._subscribe();\n    }\n  }\n\n  ngOnDestroy() {\n    this._unsubscribe();\n  }\n\n  private _subscribe() {\n    this._unsubscribe();\n    const stream = this._contentObserver.observe(this._elementRef);\n\n    // TODO(mmalerba): We shouldn't be emitting on this @Output() outside the zone.\n    // Consider brining it back inside the zone next time we're making breaking changes.\n    // Bringing it back inside can cause things like infinite change detection loops and changed\n    // after checked errors if people's code isn't handling it properly.\n    this._ngZone.runOutsideAngular(() => {\n      this._currentSubscription =\n          (this.debounce ? stream.pipe(debounceTime(this.debounce)) : stream).subscribe(this.event);\n    });\n  }\n\n  private _unsubscribe() {\n    if (this._currentSubscription) {\n      this._currentSubscription.unsubscribe();\n    }\n  }\n}\n\n\n@NgModule({\n  exports: [CdkObserveContent],\n  declarations: [CdkObserveContent],\n  providers: [MutationObserverFactory]\n})\nexport class ObserversModule {}\n"]}